import{b as R,f as y,i as A,o as D,j as o,e as b,I as x,r as c}from"./input.js";import{app as n}from"/scripts/app.js";import{W,y as N,au as O,C as B,av as J,aw as C,ax as M,w as f,N as T,ay as P}from"./App-9R6d9xnQ.js";import"/scripts/api.js";var[V,j]=R({name:"TagStylesContext",errorMessage:`useTagStyles returned is 'undefined'. Seems you forgot to wrap the components in "<Tag />" `}),I=y((e,t)=>{const s=A("Tag",e),r=D(e),l={display:"inline-flex",verticalAlign:"top",alignItems:"center",maxWidth:"100%",...s.container};return o.jsx(V,{value:s,children:o.jsx(b.span,{ref:t,...r,__css:l})})});I.displayName="Tag";var z=y((e,t)=>{const s=j();return o.jsx(b.span,{ref:t,noOfLines:1,...e,__css:s.label})});z.displayName="TagLabel";var F=y((e,t)=>o.jsx(x,{ref:t,verticalAlign:"top",marginEnd:"0.5rem",...e}));F.displayName="TagLeftIcon";var G=y((e,t)=>o.jsx(x,{ref:t,verticalAlign:"top",marginStart:"0.5rem",...e}));G.displayName="TagRightIcon";var E=e=>o.jsx(x,{verticalAlign:"inherit",viewBox:"0 0 512 512",...e,children:o.jsx("path",{fill:"currentColor",d:"M289.94 256l95-95A24 24 0 00351 127l-95 95-95-95a24 24 0 00-34 34l95 95-95 95a24 24 0 1034 34l95-95 95 95a24 24 0 0034-34z"})});E.displayName="TagCloseIcon";var H=y((e,t)=>{const{isDisabled:s,children:r,...l}=e,k={display:"flex",alignItems:"center",justifyContent:"center",outline:"0",...j().closeButton};return o.jsx(b.button,{ref:t,"aria-label":"close",...l,type:"button",disabled:s,__css:k,children:r||o.jsx(E,{})})});H.displayName="TagCloseButton";function K(e,t){const s=c.useRef(0),r=c.useCallback(()=>{s.current!==null&&(clearTimeout(s.current),s.current=0)},[]),l=c.useCallback((...m)=>{r(),s.current=setTimeout(()=>e(...m),t)},[e,t,r]);return c.useEffect(()=>()=>{r()},[]),[l,r]}function Z(){const{isDirty:e,setIsDirty:t,setRoute:s,saveCurWorkflow:r}=c.useContext(W),l=c.useRef(e),[m,k]=c.useState(!1);N();const S=c.useRef(null);c.useEffect(()=>{l.current=e},[e]),c.useEffect(()=>{var p,h;const g=i=>{var v;if(document.visibilityState==="hidden")return;const a=M(i);if(a)switch(window.dispatchEvent(new CustomEvent(J,{detail:{shortcutType:a}})),a){case C.SAVE:r();break;case C.SAVE_AS:s("saveAsModal");break}else(v=i.target)!=null&&v.matches("input, textarea")&&Object.keys(n.canvas.selected_nodes??{}).length&&w()},u=n.canvas.onAfterChange;n.graph.onAfterChange=function(){u==null||u.apply(this,arguments),w()};const d=n.graph.onConfigure;return n.graph.onConfigure=function(){d==null||d.apply(this,arguments),setTimeout(()=>{var a,v;O(n.graph.serialize(),JSON.parse(((v=(a=f)==null?void 0:a.curWorkflow)==null?void 0:v.json)??"{}"))||w()},1e3)},document.addEventListener("click",i=>{Object.keys(n.canvas.selected_nodes??{}).length&&(n.canvas.node_over!=null||n.canvas.node_capturing_input!=null||n.canvas.node_widget!=null)&&w()}),document.addEventListener("keydown",g),(h=(p=T)==null?void 0:p.settings)!=null&&h.autoSave&&T.settings.autoSaveDuration&&(S.current=setInterval(()=>{_()},T.settings.autoSaveDuration*1e3)),()=>{document.removeEventListener("keydown",g),S.current&&clearInterval(S.current)}},[]);const _=async()=>{var u,d,p,h,i,a;if((d=(u=f)==null?void 0:u.curWorkflow)!=null&&d.saveLock||!((h=(p=f)==null?void 0:p.curWorkflow)!=null&&h.id)||!l.current)return;const g=JSON.stringify(n.graph.serialize());await((i=f)==null?void 0:i.updateFlow(f.curWorkflow.id,{json:g})),(a=P)==null||a.create({workflowID:f.curWorkflow.id,isAutoSave:!0,json:g}),t(!1)},L=async()=>{var g,u,d,p,h,i,a;(u=(g=f)==null?void 0:g.curWorkflow)!=null&&u.saveLock||l.current||(t(!0),(p=(d=T)==null?void 0:d.settings)!=null&&p.autoSave&&((i=(h=f)==null?void 0:h.curWorkflow)!=null&&i.id)&&!m&&(await((a=f)==null?void 0:a.latestVersionCheck())||k(!0)))},[w,U]=K(L,900);return m?o.jsx(B,{label:"This workflow was changed by another tab, so you are not working on the latest version. Please refresh page to see the latest version of this workflow.",children:o.jsx(I,{colorScheme:"yellow",children:"⚠️Outdated version"})}):null}export{Z as default};
